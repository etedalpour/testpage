<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Info & Wallet</title>
</head>
<body>
  <h1>Welcome, <span id="githubUsername">Loading...</span>!</h1>
  <p><strong>GitHub User ID:</strong> <span id="githubUserId">Loading...</span></p>

  <hr />

  <h2>Select one of your Repos</h2>
  <select id="repoSelect">
    <option value="">Select a repo</option>
    <!-- JS will populate these options -->
  </select>

  <div id="repoDetails" style="margin-top: 1em; padding: 1em; border: 1px solid #ccc;">
    <!-- JS will display repo details here -->
  </div>

  <button id="monetizeBtn" style="margin-top: 1em;">Monetize</button>

  <hr />

  <h2>Your Wallet Details</h2>
  <p><strong>Public Key:</strong> <span id="publicKey">Loading...</span></p>
  <p><strong>Account Address:</strong> <span id="accountAddress">Loading...</span></p>
  <p><strong>Wallet Balance:</strong> <span id="walletBalance">Loading...</span> SOL</p>

  <script>
    // Replace with whatever endpoint in your server returns user info + repos + wallet
    const userDataEndpoint = "https://alietedal.ir:8080/api/user-data";

    // (Optionally) keep your existing wallet endpoint call if your server
    // separately returns wallet details at another route.
    // Otherwise, if userDataEndpoint *already* has wallet info, you can remove the second fetch.

    async function fetchUserData() {
      try {
        const res = await fetch(userDataEndpoint, {
          credentials: "include",
        });
        if (!res.ok) {
          throw new Error(`Failed to fetch user data: HTTP ${res.status}`);
        }
        const data = await res.json();

        // Populate GitHub user info
        document.getElementById("githubUsername").textContent = data.username || "N/A";
        document.getElementById("githubUserId").textContent = data.userId || "N/A";

        // Populate repos dropdown
        const repoSelect = document.getElementById("repoSelect");
        if (Array.isArray(data.repos)) {
          data.repos.forEach((repo) => {
            const option = document.createElement("option");
            option.value = repo.name; // or a unique ID
            option.textContent = repo.name;
            // Store entire repo object in option.dataset if you like:
            // option.dataset.repo = JSON.stringify(repo);
            repoSelect.appendChild(option);
          });
        }

        // If the server also sends wallet in data, we can populate it:
        if (data.wallet) {
          document.getElementById("publicKey").textContent = data.wallet.publicKey || "N/A";
          document.getElementById("accountAddress").textContent = data.wallet.publicKey || "N/A";
          document.getElementById("walletBalance").textContent = data.wallet.balance || "0";
        }

      } catch (err) {
        console.error("Error fetching user data:", err);
      }
    }

    // Alternatively, if your wallet is fetched from another endpoint:
    async function fetchWalletDetails() {
      try {
        const response = await fetch("https://alietedal.ir:600/api/user-wallet");
        const data = await response.json();

        if (data.success) {
          document.getElementById("publicKey").textContent = data.wallet.publicKey;
          document.getElementById("accountAddress").textContent = data.wallet.publicKey;
          document.getElementById("walletBalance").textContent = data.wallet.balance;
        } else {
          console.warn("Error fetching wallet details:", data.message);
        }
      } catch (error) {
        console.error("Failed to fetch wallet details:", error);
      }
    }

    function displayRepoDetails(repoName) {
      const container = document.getElementById("repoDetails");
      container.innerHTML = ""; // Clear old info

      if (!repoName) {
        container.textContent = "No repository selected.";
        return;
      }

      // In a real app, you’d find the selected repo from the userData in memory, or re-fetch it.
      // For simplicity, we can just re-parse from the dropdown, or keep a local variable “repos”.

      // Example: If we stored them in window.userRepos from fetchUserData:
      const repo = window.userRepos?.find((r) => r.name === repoName);

      if (!repo) {
        container.textContent = "Could not find details for the selected repo.";
        return;
      }

      // Show some basic fields
      const ul = document.createElement("ul");
      const fieldsToShow = ["full_name", "html_url", "description", "created_at", "updated_at", "pushed_at"];

      fieldsToShow.forEach((field) => {
        const li = document.createElement("li");
        li.textContent = `${field}: ${repo[field] || "N/A"}`;
        ul.appendChild(li);
      });
      container.appendChild(ul);
    }

    async function monetizeRepo() {
      try {
        const repoSelect = document.getElementById("repoSelect");
        const selectedRepoName = repoSelect.value;
        if (!selectedRepoName) {
          alert("Please select a repository first.");
          return;
        }

        // Example call to /api/monetize
        const response = await fetch("https://alietedal.ir:8080/api/monetize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ repoName: selectedRepoName }),
        });

        if (!response.ok) {
          throw new Error(`Monetize request failed: HTTP ${response.status}`);
        }

        const data = await response.json();
        if (data.success) {
          alert(`Repo "${selectedRepoName}" monetized successfully!`);
        } else {
          alert(`Monetization failed: ${data.message}`);
        }
      } catch (err) {
        console.error("Error calling monetize API:", err);
        alert("Error calling monetize API: " + err.message);
      }
    }

    // Event listeners
    window.addEventListener("DOMContentLoaded", () => {
      // 1. Fetch user + repos
      fetchUserData().then(() => {
        // If you want to separately fetch the wallet from a distinct endpoint:
        // fetchWalletDetails();
      });

      // 2. Listen for repo dropdown changes
      const repoSelect = document.getElementById("repoSelect");
      repoSelect.addEventListener("change", (e) => {
        displayRepoDetails(e.target.value);
      });

      // 3. Monetize button
      document.getElementById("monetizeBtn").addEventListener("click", monetizeRepo);
    });
  </script>
</body>
</html>
