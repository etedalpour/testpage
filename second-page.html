<script>
    const DEBUG = true;
    const log = (...args) => { if (DEBUG) console.log(...args); };

    async function init() {
        log("Initializing application...");
        updateStatusMessage("githubStatus", "Checking authentication...", "info");

        const storedUserData = localStorage.getItem('githubUserData');
        const storedReposData = localStorage.getItem('githubReposData');
        
        if (storedUserData && storedReposData) {
            log("Found stored GitHub data");
            const userData = JSON.parse(storedUserData);
            const userRepos = JSON.parse(storedReposData);
            updateGitHubUI(userData, userRepos);
            setupEventHandlers(userRepos);
            updateStatusMessage("githubStatus", "Using cached GitHub data", "success");
        } else {
            log("No GitHub data found in local storage.");
            document.getElementById("githubUsername").textContent = "Not logged in";
            document.getElementById("githubUserId").textContent = "Not logged in";
            updateStatusMessage("githubStatus", "Not logged in with GitHub", "info");
        }
    }

    function setupEventHandlers(userRepos) {
        const repoDropdown = document.getElementById("repoDropdown");
        const repoDetailsList = document.getElementById("repoDetailsList");

        repoDropdown.addEventListener("change", () => {
            const selectedRepoName = repoDropdown.value;
            log("Selected Repo Name:", selectedRepoName);

            const selectedRepo = userRepos.find(repo => repo.name === selectedRepoName);
            log("Selected Repo Object:", selectedRepo);

            repoDetailsList.innerHTML = "";

            if (selectedRepo) {
                const keyInfo = {
                    "Name": selectedRepo.name,
                    "Description": selectedRepo.description || "No description",
                    "Language": selectedRepo.language || "Not specified",
                    "Stars": selectedRepo.stargazers_count,
                    "Forks": selectedRepo.forks_count,
                    "Created": new Date(selectedRepo.created_at).toLocaleDateString(),
                    "Last Updated": new Date(selectedRepo.updated_at).toLocaleDateString()
                };

                for (const [key, value] of Object.entries(keyInfo)) {
                    const li = document.createElement("li");
                    li.textContent = `${key}: ${value}`;
                    repoDetailsList.appendChild(li);
                }
            } else {
                console.error("Repository not found in the userRepos array.", selectedRepoName);
            }
        });
    }

    function updateGitHubUI(userData, userRepos) {
        document.getElementById("githubUsername").textContent = userData.login || "Unknown";
        document.getElementById("githubUserId").textContent = userData.id || "Unknown";

        const repoDropdown = document.getElementById("repoDropdown");
        repoDropdown.innerHTML = '<option value="">Select a repository</option>';

        if (userRepos && userRepos.length > 0) {
            userRepos.forEach(repo => {
                const option = document.createElement("option");
                option.value = repo.name;
                option.textContent = repo.name;
                repoDropdown.appendChild(option);
            });
        } else {
            const option = document.createElement("option");
            option.textContent = "No repositories found";
            repoDropdown.appendChild(option);
        }
    }

    function updateStatusMessage(elementId, message, type) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        element.textContent = message;
        element.className = type || "info";
    }

    window.addEventListener('DOMContentLoaded', init);
</script>
