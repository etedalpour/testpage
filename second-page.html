<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Wallet</title>
</head>
<body>
    <h1>User Wallet Details</h1>
    <p><strong>Public Key:</strong> <span id="publicKey">Loading...</span></p>
    <p><strong>Account Address:</strong> <span id="accountAddress">Loading...</span></p>
    <p><strong>Wallet Balance:</strong> <span id="walletBalance">Loading...</span> SOL</p>

    <h2>GitHub User Info</h2>
    <p><strong>Username:</strong> <span id="githubUsername">Loading...</span></p>
    <p><strong>User ID:</strong> <span id="githubUserId">Loading...</span></p>

    <h2>Repositories</h2>
    <select id="repoDropdown">
        <option value="">Select a repository</option>
    </select>

    <div id="repoDetails" style="margin-top: 20px;">
        <h3>Repository Details</h3>
        <ul id="repoDetailsList"></ul>
    </div>

    <button id="monetizeButton" style="margin-top: 20px;">Monetize</button>

    <script>
        async function fetchWalletDetails() {
            try {
                const response = await fetch("https://alietedal.ir:600/api/user-wallet");
                const data = await response.json();

                if (data.success) {
                    document.getElementById("publicKey").textContent = data.wallet.publicKey;
                    document.getElementById("accountAddress").textContent = data.wallet.publicKey;
                    document.getElementById("walletBalance").textContent = data.wallet.balance;
                } else {
                    alert("Error fetching wallet details.");
                }
            } catch (error) {
                console.error("Failed to fetch wallet details:", error);
            }
        }

        async function fetchGitHubUserData() {
            try {
                const response = await fetch("https://alietedal.ir:8080/api/github-auth", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    credentials: 'include',
                    body: JSON.stringify({ code: new URLSearchParams(window.location.search).get("code") })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById("githubUsername").textContent = data.user.login;
                    document.getElementById("githubUserId").textContent = data.user.id;

                    const repoDropdown = document.getElementById("repoDropdown");
                    data.repos.forEach(repo => {
                        const option = document.createElement("option");
                        option.value = repo.name;
                        option.textContent = repo.name;
                        repoDropdown.appendChild(option);
                    });

                    repoDropdown.addEventListener("change", () => {
                        const selectedRepo = data.repos.find(repo => repo.name === repoDropdown.value);
                        const repoDetailsList = document.getElementById("repoDetailsList");
                        repoDetailsList.innerHTML = "";

                        if (selectedRepo) {
                            for (const [key, value] of Object.entries(selectedRepo)) {
                                const li = document.createElement("li");
                                li.textContent = `${key}: ${value}`;
                                repoDetailsList.appendChild(li);
                            }
                        }
                    });

                    document.getElementById("monetizeButton").addEventListener("click", async () => {
                        const selectedRepo = repoDropdown.value;
                        if (selectedRepo) {
                            const response = await fetch("https://alietedal.ir:8080/api/monetize", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({ repoName: selectedRepo })
                            });

                            const result = await response.json();
                            alert(result.message);
                        } else {
                            alert("Please select a repository to monetize.");
                        }
                    });
                } else {
                    alert("Error fetching GitHub user data.");
                }
            } catch (error) {
                console.error("Failed to fetch GitHub user data:", error);
            }
        }

        fetchWalletDetails();
        fetchGitHubUserData();
    </script>
</body>
</html>
